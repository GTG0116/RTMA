<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>RTMA Weather Viewer</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        body { margin:0; padding:0; font-family: 'Segoe UI', system-ui, sans-serif; background:#0f172a; color:#e0f0ff; }
        #map { position: absolute; inset:0; }
        #ui {
            position: absolute; top:10px; left:10px; z-index: 10;
            background: rgba(15,23,42,0.75); backdrop-filter: blur(10px);
            border: 1px solid rgba(100,160,255,0.3); border-radius: 10px;
            padding: 12px 16px; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }
        #status { margin-bottom: 10px; font-size: 13px; }
        .loading::before { content:"⏳ "; }
        .ok::before { content:"✅ "; }
        .error::before { content:"⚠️ "; }
        label { display: block; margin: 6px 0; cursor: pointer; }
        #opacity-container { margin-top:12px; }
        #legend {
            position: absolute; bottom:15px; left:15px; z-index:10;
            background: rgba(15,23,42,0.85); backdrop-filter: blur(12px);
            border: 1px solid rgba(100,160,255,0.25); border-radius: 10px;
            padding: 12px 16px; box-shadow: 0 6px 24px rgba(0,0,0,0.6);
            min-width: 220px; display: none;
        }
        #legend-title { font-weight:600; margin-bottom:6px; }
        .gradient { height:12px; border-radius:6px; margin:8px 0; }
        .labels { display:flex; justify-content:space-between; font-size:12px; color:#94a3b8; }

        /* ── Improved Popup ──────────────────────────────────────── */
        .mapboxgl-popup { z-index: 1001; }
        .mapboxgl-popup-content {
            background: rgba(6, 18, 52, 0.92);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(100, 160, 255, 0.35);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0,0,50,0.7);
            color: #e0f0ff;
            padding: 14px 18px;
            min-width: 220px;
            max-width: 320px;
            font-size: 14px;
            line-height: 1.45;
        }
        .mapboxgl-popup-tip { border-top-color: rgba(6,18,52,0.92) !important; }
        .popup-layer-name {
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
            color: #60a5fa;
            margin-bottom: 6px;
        }
        .popup-value {
            font-size: 24px;
            font-weight: 700;
            color: #e0f0ff;
            margin: 6px 0 4px;
        }
        .popup-unit {
            font-size: 16px;
            font-weight: 500;
            color: #94a3b8;
        }
        .popup-coords {
            font-size: 12px;
            color: #64748b;
            margin-top: 8px;
            opacity: 0.9;
        }
        .popup-unavailable {
            font-size: 14px;
            color: #f87171;
            font-style: italic;
            margin: 8px 0;
        }
        .mapboxgl-popup-close-button { color:#60a5fa !important; font-size:16px; }

        /* Hide unwanted Mapbox elements */
        .mapboxgl-ctrl-logo, .mapboxgl-ctrl-bottom-right { display:none !important; }

        /* Mobile optimizations to prevent crashes */
        @media (max-width: 768px) {
            #ui, #legend, .mapboxgl-popup-content {
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <div id="ui">
        <div id="status" class="loading">Loading...</div>
        <div id="status-text"></div>
        <label><input type="radio" name="layer" value="temp" checked> Temperature</label>
        <label><input type="radio" name="layer" value="apparent"> Apparent Temp</label>
        <label><input type="radio" name="layer" value="wind"> Wind Speed</label>
        <label><input type="radio" name="layer" value="rh"> Relative Humidity</label>
        <label><input type="radio" name="layer" value="vis"> Visibility</label>
        <label><input type="radio" name="layer" value="cloud"> Cloud Cover</label>
        <div id="opacity-container">
            <label>Opacity: <span id="opacity-value">65%</span></label>
            <input type="range" id="opacity-slider" min="0" max="100" value="65" step="1"/>
        </div>
    </div>

    <div id="legend">
        <div id="legend-title"></div>
        <div id="legend-gradient" class="gradient"></div>
        <div class="labels">
            <span id="min-label"></span>
            <span id="max-label"></span>
        </div>
    </div>

    <script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
    <script>
        mapboxgl.accessToken = 'pk.eyJ1IjoiZ3RnMDExNiIsImEiOiJjbWxsODV6NXAwNThmM2ZwdWlkYm0xNjFlIn0.vI186twXYzY45nnuV5FucQ';

        const ALL_LAYERS = ['temp', 'wind', 'apparent', 'vis', 'cloud', 'rh'];

        const legendConfigs = {
            temp:     { title:'Temperature (°F)',       min:-20, max:110, gradient:'linear-gradient(to right,#30123b,#3c59ff,#00ffff,#7cff00,#ffff00,#ff7f00,#ff0000)', unit:'°F' },
            wind:     { title:'Wind Speed (mph)',       min:0,   max:60,  gradient:'linear-gradient(to right,#440154,#3b528b,#21908c,#5dc863,#fde725)', unit:' mph' },
            apparent: { title:'Apparent Temperature (°F)', min:-30, max:120, gradient:'linear-gradient(to right,#30123b,#3c59ff,#00ffff,#7cff00,#ffff00,#ff7f00,#ff0000)', unit:'°F' },
            vis:      { title:'Visibility (mi)',        min:0,   max:10,  gradient:'linear-gradient(to right, #4b0082, #ff4500, #ffff00)', unit:' mi' },  // Purple (0) to orange to yellow (10)
            cloud:    { title:'Cloud Cover (%)',        min:0,   max:100, gradient:'linear-gradient(to right,#f0f9ff,#e0f2fe,#bae6fd,#7dd3fc,#38bdf8,#0ea5e9)', unit:'%' },
            rh:       { title:'Relative Humidity (%)',  min:0,   max:100, gradient:'linear-gradient(to right,#ffffd9,#c7e9b4,#41b6c4,#225ea8,#081d58)', unit:'%' }
        };

        const map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: [-98.5795, 39.8283],
            zoom: 4
        });

        let activeLayer = 'temp';
        let pendingBounds = null;
        let dataCache = {};
        let dataMeta = null;
        let valuePopup = null;
        let boundsArr = [24.0, -126.0, 50.0, -66.0]; // fallback

        function toMapboxCoords(b) {
            const [minLat, minLon, maxLat, maxLon] = b;
            return [[minLon, maxLat], [maxLon, maxLat], [maxLon, minLat], [minLon, minLat]];
        }

        function getSelectedLayer() {
            const checked = document.querySelector('input[name="layer"]:checked');
            return checked ? checked.value : 'temp';
        }

        function updateLegend(name) {
            const legendDiv = document.getElementById('legend');
            if (name === 'none' || !legendConfigs[name]) {
                legendDiv.style.display = 'none';
                return;
            }
            const cfg = legendConfigs[name];
            document.getElementById('legend-title').textContent = cfg.title;
            document.getElementById('min-label').textContent = cfg.min;
            document.getElementById('max-label').textContent = cfg.max;
            document.getElementById('legend-gradient').style.background = cfg.gradient;
            legendDiv.style.display = 'block';
        }

        function applyBounds(b) {
            boundsArr = b;
            const coords = toMapboxCoords(b);
            ALL_LAYERS.forEach(name => {
                const src = map.getSource(name + '-src');
                if (src) src.setCoordinates(coords);
            });
        }

        function showLayer(val) {
            activeLayer = val;
            if (!map.isStyleLoaded()) {
                updateLegend(val);
                loadLayerData(val);
                return;
            }
            ALL_LAYERS.forEach(name => {
                const layerId = name + '-layer';
                if (map.getLayer(layerId)) {
                    map.setLayoutProperty(layerId, 'visibility', name === val ? 'visible' : 'none');
                }
            });
            updateLegend(val);
            loadLayerData(val);
        }

        function loadLayerData(name) {
            if (name === 'none' || !dataMeta) return;
            if (dataCache[name]) return;
            fetch(`./data/${name}_data.bin`)
                .then(r => { if (!r.ok) throw new Error(); return r.arrayBuffer(); })
                .then(buf => { dataCache[name] = new Float32Array(buf); })
                .catch(() => {}); // silent fail
        }

        function lookupValue(name, lng, lat) {
            const arr = dataCache[name];
            if (!arr || !dataMeta) return null;
            const { rows, cols } = dataMeta;
            const [minLat, minLon, maxLat, maxLon] = boundsArr;
            const rowFrac = (lat - minLat) / (maxLat - minLat);
            const colFrac = (lng - minLon) / (maxLon - minLon);
            if (rowFrac < 0 || rowFrac > 1 || colFrac < 0 || colFrac > 1) return null;
            const row = Math.min(rows - 1, Math.max(0, Math.round(rowFrac * (rows - 1))));
            const col = Math.min(cols - 1, Math.max(0, Math.round(colFrac * (cols - 1))));
            const val = arr[row * cols + col];
            return (isFinite(val) && !isNaN(val)) ? val : null;
        }

        function formatValue(name, val) {
            const cfg = legendConfigs[name];
            if (!cfg) return val.toFixed(1);
            if (name === 'cloud' || name === 'rh') return Math.round(val);
            if (name === 'vis') return val.toFixed(2);
            return val.toFixed(1);
        }

        function getFirstLabelLayerId() {
            const layers = map.getStyle().layers;
            for (const layer of layers) {
                if (layer.type === 'symbol' && layer.id.toLowerCase().includes('label')) {
                    return layer.id;
                }
            }
            return undefined;
        }

        map.on('load', () => {
            const coords = toMapboxCoords(boundsArr);
            const beforeId = getFirstLabelLayerId();

            ALL_LAYERS.forEach(name => {
                map.addSource(name + '-src', {
                    type: 'image',
                    url: `./data/${name}.png`,
                    coordinates: coords
                });
                map.addLayer({
                    id: name + '-layer',
                    type: 'raster',
                    source: name + '-src',
                    paint: { 'raster-opacity': 0.65 },
                    layout: { visibility: name === activeLayer ? 'visible' : 'none' }  // Initial layer visible
                }, beforeId);
            });

            // ── Add visible country, state & county boundaries on top ──────
            map.addLayer({
                id: 'country-outline',
                type: 'line',
                source: { type: 'vector', url: 'mapbox://mapbox.mapbox-streets-v8' },
                'source-layer': 'admin',
                filter: ['==', 'admin_level', 0],
                paint: {
                    'line-color': '#3b82f6',
                    'line-width': 2,
                    'line-opacity': 0.6
                }
            });  // No beforeId to place on top

            map.addLayer({
                id: 'states-outline',
                type: 'line',
                source: { type: 'vector', url: 'mapbox://mapbox.mapbox-streets-v8' },
                'source-layer': 'admin',
                filter: ['==', 'admin_level', 2],
                paint: {
                    'line-color': '#60a5fa',
                    'line-width': 1.2,
                    'line-opacity': 0.45
                }
            });  // On top

            map.addLayer({
                id: 'states-labels',
                type: 'symbol',
                source: { type: 'vector', url: 'mapbox://mapbox.mapbox-streets-v8' },
                'source-layer': 'admin',
                filter: ['==', 'admin_level', 2],
                layout: {
                    'text-field': ['get', 'name_en'],
                    'text-size': 11,
                    'text-font': ['Open Sans Semibold'],
                    'text-max-width': 8,
                    'text-padding': 4
                },
                paint: {
                    'text-color': '#a5b4fc',
                    'text-halo-color': '#0f172a',
                    'text-halo-width': 1.5,
                    'text-halo-blur': 1
                }
            });  // On top

            map.addLayer({
                id: 'counties-outline',
                type: 'line',
                source: { type: 'vector', url: 'mapbox://mapbox.mapbox-streets-v8' },
                'source-layer': 'admin',
                filter: ['==', 'admin_level', 4],
                minzoom: 7,
                paint: {
                    'line-color': '#94a3b8',
                    'line-width': 0.8,
                    'line-opacity': 0.25
                }
            });  // On top

            if (pendingBounds) {
                applyBounds(pendingBounds);
                pendingBounds = null;
            }

            showLayer(activeLayer);  // Ensure initial visibility and data load
        });

        // Opacity slider
        const opacitySlider = document.getElementById('opacity-slider');
        const opacityLabel = document.getElementById('opacity-value');
        opacitySlider.addEventListener('input', () => {
            const val = opacitySlider.value / 100;
            opacityLabel.textContent = opacitySlider.value + '%';
            ALL_LAYERS.forEach(name => {
                const layerId = name + '-layer';
                if (map.getLayer(layerId)) {
                    map.setPaintProperty(layerId, 'raster-opacity', val);
                }
            });
        });

        // Layer radio buttons
        document.querySelectorAll('input[name="layer"]').forEach(radio => {
            radio.addEventListener('change', () => showLayer(radio.value));
        });

        // Double-click popup
        map.on('dblclick', e => {
            const name = getSelectedLayer();
            if (name === 'none') return;
            if (valuePopup) valuePopup.remove();

            const lng = e.lngLat.lng;
            const lat = e.lngLat.lat;
            const val = lookupValue(name, lng, lat);
            const cfg = legendConfigs[name];

            let html = '';
            if (val !== null) {
                const displayVal = formatValue(name, val);
                const unit = cfg?.unit || '';
                html = `
                    <div class="popup-layer-name">${cfg?.title || name}</div>
                    <div>
                        <span class="popup-value">${displayVal}</span>
                        <span class="popup-unit">${unit}</span>
                    </div>
                    <div class="popup-coords">${lat.toFixed(3)}°, ${lng.toFixed(3)}°</div>
                `;
            } else {
                html = `
                    <div class="popup-layer-name">${cfg?.title || name}</div>
                    <div class="popup-unavailable">No data available at this location</div>
                    <div class="popup-coords">${lat.toFixed(3)}°, ${lng.toFixed(3)}°</div>
                `;
            }

            valuePopup = new mapboxgl.Popup({
                closeButton: true,
                closeOnClick: false,
                maxWidth: '320px'
            })
            .setLngLat([lng, lat])
            .setHTML(html)
            .addTo(map);
        });

        map.doubleClickZoom.disable();

        // Initial setup
        activeLayer = getSelectedLayer();
        updateLegend(activeLayer);

        // Metadata fetch
        fetch('./data/metadata.json')
            .then(r => { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
            .then(meta => {
                const statusDiv = document.getElementById('status');
                const statusText = document.getElementById('status-text');
                statusDiv.classList.remove('loading');
                statusDiv.classList.add('ok');
                const ts = new Date(meta.timestamp).toLocaleString();
                statusText.innerHTML = `<span style="color:#22c55e;font-weight:600">Live</span> — ${ts}`;

                const b = meta.bounds;
                const newBounds = [b[0][0], b[0][1], b[1][0], b[1][1]];

                if (map.isStyleLoaded()) {
                    applyBounds(newBounds);
                } else {
                    pendingBounds = newBounds;
                }

                if (meta.data_rows && meta.data_cols) {
                    dataMeta = { rows: meta.data_rows, cols: meta.data_cols };
                    loadLayerData(activeLayer);
                }

                if (map.isStyleLoaded()) {
                    showLayer(activeLayer);
                }
            })
            .catch(err => {
                console.error(err);
                const statusDiv = document.getElementById('status');
                const statusText = document.getElementById('status-text');
                statusDiv.classList.remove('loading');
                statusDiv.classList.add('error');
                statusText.innerHTML = 'No data yet — pipeline has not run.<br><span style="font-size:11px;color:#64748b">Check GitHub Actions workflow.</span>';
            });
    </script>
</body>
</html>
