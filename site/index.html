<!DOCTYPE html>
<html>
<head>
    <title>RTMA Weather Viewer</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        body { margin: 0; padding: 0; background: #222; color: white; font-family: sans-serif; }
        #map { width: 100vw; height: 100vh; }
        #status { 
            position: absolute; top: 10px; left: 10px; z-index: 1000; 
            background: rgba(0,0,0,0.7); padding: 12px; border-radius: 6px; 
            pointer-events: none; 
        }
        #controls { 
            position: absolute; top: 10px; right: 10px; z-index: 1000; 
            background: rgba(0,0,0,0.7); padding: 12px; border-radius: 6px; 
        }
        label { display: block; margin: 6px 0; cursor: pointer; }
        .legend { 
            position: absolute; bottom: 30px; left: 10px; z-index: 1000; 
            background: rgba(0,0,0,0.7); padding: 10px; border-radius: 6px; 
            color: white; min-width: 220px; display: none; 
        }
        .legend .gradient {
            height: 12px; margin: 8px 0; border-radius: 4px;
        }
        .legend .labels { display: flex; justify-content: space-between; font-size: 12px; }
    </style>
</head>
<body>
<div id="status">Loading data...</div>
<div id="map"></div>

<div id="controls">
    <strong>Overlay:</strong><br>
    <label><input type="radio" name="layer" value="temp" checked> Temperature</label>
    <label><input type="radio" name="layer" value="wind"> Wind Speed</label>
    <label><input type="radio" name="layer" value="apparent"> Apparent Temperature</label>
    <label><input type="radio" name="layer" value="none"> None</label>
</div>

<div class="legend" id="legend">
    <div id="legend-title"><strong>Temperature (°F)</strong></div>
    <div class="gradient" id="legend-gradient"></div>
    <div class="labels">
        <span id="min-label">-20</span>
        <span id="max-label">110</span>
    </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
    // Create map with zoom animation DISABLED to fix image disappear glitch
    var map = L.map('map', {
        center: [39.8283, -98.5795],
        zoom: 4,
        zoomAnimation: false,           // Prevents image from hiding/disappearing during zoom
        markerZoomAnimation: false
    });

    // Custom pane for RTMA images — below Mapbox tile labels (towns, borders, roads)
    map.createPane('rtmaPane');
    map.getPane('rtmaPane').style.zIndex = 150;  // tilePane is 200 → labels stay on top

    var statusDiv = document.getElementById('status');
    var legendDiv = document.getElementById('legend');

    // Mapbox Dark v11 basemap – REPLACE THE TOKEN!
    L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/dark-v11/tiles/{z}/{x}/{y}?access_token={accessToken}', {
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, <a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="https://www.mapbox.com/">Mapbox</a>',
        maxZoom: 18,
        tileSize: 512,
        zoomOffset: -1,
        accessToken: 'pk.eyJ1IjoiZ3RnMDExNiIsImEiOiJjbWxsODV6NXAwNThmM2ZwdWlkYm0xNjFlIn0.vI186twXYzY45nnuV5FucQ'   // ← Get free token at mapbox.com
    }).addTo(map);

    // Image layers (added to low pane)
    const layers = {
        temp: L.imageOverlay("./data/temp.png", [[0,0],[0,0]], { 
            opacity: 0.65, pane: 'rtmaPane', interactive: false 
        }),
        wind: L.imageOverlay("./data/wind.png", [[0,0],[0,0]], { 
            opacity: 0.65, pane: 'rtmaPane', interactive: false 
        }),
        apparent: L.imageOverlay("./data/apparent.png", [[0,0],[0,0]], { 
            opacity: 0.65, pane: 'rtmaPane', interactive: false 
        })
    };

    // Legend configuration per layer
    const legendConfigs = {
        temp: { 
            title: "Temperature (°F)", 
            min: -20, max: 110,
            gradient: 'linear-gradient(to right, #30123b, #3c59ff, #00ffff, #7cff00, #ffff00, #ff7f00, #ff0000)'
        },
        wind: { 
            title: "Wind Speed (mph)", 
            min: 0, max: 60,
            gradient: 'linear-gradient(to right, #440154, #3b528b, #21908c, #5dc863, #fde725)'
        },
        apparent: { 
            title: "Apparent Temperature (°F)", 
            min: -40, max: 140,
            gradient: 'linear-gradient(to right, #30123b, #3c59ff, #00ffff, #7cff00, #ffff00, #ff7f00, #ff0000)'
        }
    };

    function updateLegend(layerName) {
        if (layerName === 'none') {
            legendDiv.style.display = 'none';
            return;
        }
        const cfg = legendConfigs[layerName];
        document.getElementById('legend-title').innerHTML = `<strong>${cfg.title}</strong>`;
        document.getElementById('min-label').textContent = cfg.min;
        document.getElementById('max-label').textContent = cfg.max;
        document.getElementById('legend-gradient').style.background = cfg.gradient;
        legendDiv.style.display = 'block';
    }

    // Layer radio buttons
    document.querySelectorAll('input[name="layer"]').forEach(radio => {
        radio.addEventListener('change', () => {
            Object.values(layers).forEach(l => {
                if (map.hasLayer(l)) map.removeLayer(l);
            });
            const val = radio.value;
            if (val !== 'none' && layers[val]) {
                layers[val].addTo(map);
            }
            updateLegend(val);
        });
    });

    // Load metadata and apply bounds
    fetch('./data/metadata.json')
        .then(response => {
            if (!response.ok) throw new Error(`HTTP ${response.status}`);
            return response.json();
        })
        .then(meta => {
            const ts = new Date(meta.timestamp).toLocaleString();
            statusDiv.innerHTML = `Data Timestamp: ${ts}<br>Bounds loaded.`;

            const b = meta.bounds;
            const imageBounds = [[b[0][0], b[0][1]], [b[1][0], b[1][1]]];

            Object.values(layers).forEach(layer => {
                layer.setBounds(imageBounds);
                layer.redraw();  // Force redraw to help with initial visibility
            });

            // Show temperature by default
            layers.temp.addTo(map);
            updateLegend('temp');
        })
        .catch(err => {
            console.error(err);
            statusDiv.innerHTML = `Error: ${err.message}<br>Check console / data folder / server paths.`;
            statusDiv.style.background = "rgba(200,0,0,0.8)";
        });
</script>
</body>
</html>
