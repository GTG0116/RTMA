<!DOCTYPE html>
<html>
<head>
    <title>RTMA Weather Viewer</title>
    <link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet" />
    <style>
        /* ===== RESET & BASE ===== */
        *, *::before, *::after { box-sizing: border-box; }
        body {
            margin: 0; padding: 0;
            background: #030c1a;
            color: #e0f0ff;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        #map { width: 100vw; height: 100vh; }

        /* ===== LIQUID GLASS BASE ===== */
        .glass {
            background: rgba(6, 18, 52, 0.52);
            backdrop-filter: blur(22px) saturate(180%);
            -webkit-backdrop-filter: blur(22px) saturate(180%);
            border: 1px solid rgba(100, 160, 255, 0.18);
            box-shadow:
                0 8px 32px rgba(0, 8, 50, 0.55),
                inset 0 1px 0 rgba(255, 255, 255, 0.07),
                inset 0 -1px 0 rgba(0, 15, 70, 0.4);
            border-radius: 14px;
        }

        /* ===== TITLE BADGE (top-center) ===== */
        #title-badge {
            position: absolute; top: 16px; left: 50%; transform: translateX(-50%);
            z-index: 1000; padding: 9px 22px; pointer-events: none; white-space: nowrap;
        }
        #title-badge .badge-text {
            font-size: 12px; font-weight: 700; letter-spacing: 0.12em;
            text-transform: uppercase;
            background: linear-gradient(135deg, #93c5fd 0%, #60a5fa 50%, #818cf8 100%);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* ===== STATUS PANEL (top-left) ===== */
        #status {
            position: absolute; top: 16px; left: 16px; z-index: 1000;
            padding: 12px 16px; pointer-events: none; min-width: 230px;
            transition: border-color 0.4s;
        }
        #status .status-header {
            display: flex; align-items: center; gap: 6px;
            font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
            text-transform: uppercase; color: #60a5fa; margin-bottom: 5px;
        }
        .status-dot {
            width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
            background: #f59e0b; box-shadow: 0 0 6px #f59e0b;
        }
        #status.ok    .status-dot { background: #22c55e; box-shadow: 0 0 6px #22c55e; animation: none; }
        #status.error .status-dot { background: #ef4444; box-shadow: 0 0 6px #ef4444; animation: none; }
        #status.loading .status-dot { animation: pulse 1.4s ease-in-out infinite; }
        #status.error { border-color: rgba(239, 68, 68, 0.3); }
        #status.ok    { border-color: rgba(34, 197, 94, 0.22); }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.25; } }
        .status-text { font-size: 12px; color: #94a3b8; line-height: 1.6; }

        /* ===== CONTROLS PANEL (top-right) ===== */
        #controls {
            position: absolute; top: 16px; right: 16px; z-index: 1000;
            padding: 16px 18px; min-width: 186px;
        }
        .panel-title {
            font-size: 10px; font-weight: 700; letter-spacing: 0.12em;
            text-transform: uppercase; color: #60a5fa;
            margin-bottom: 13px; padding-bottom: 9px;
            border-bottom: 1px solid rgba(100, 160, 255, 0.14);
        }

        /* Custom radio buttons */
        .layer-option {
            display: flex; align-items: center; margin: 9px 0;
            cursor: pointer; user-select: none;
        }
        .layer-option input[type="radio"] { display: none; }
        .radio-dot {
            width: 15px; height: 15px; border-radius: 50%;
            border: 2px solid rgba(100, 160, 255, 0.35);
            margin-right: 10px; flex-shrink: 0;
            transition: border-color 0.2s, background 0.2s, box-shadow 0.2s;
            background: transparent; position: relative;
        }
        .layer-option input[type="radio"]:checked ~ .radio-dot {
            border-color: #3b82f6; background: #3b82f6;
            box-shadow: 0 0 9px rgba(59, 130, 246, 0.65);
        }
        .layer-option input[type="radio"]:checked ~ .radio-dot::after {
            content: ''; position: absolute;
            width: 5px; height: 5px; border-radius: 50%; background: #fff;
            top: 50%; left: 50%; transform: translate(-50%, -50%);
        }
        .layer-label { font-size: 13px; color: #94a3b8; transition: color 0.2s; }
        .layer-option:has(input:checked) .layer-label { color: #e0f2fe; font-weight: 500; }

        /* Opacity Slider */
        .slider-section {
            margin-top: 14px; padding-top: 12px;
            border-top: 1px solid rgba(100, 160, 255, 0.10);
        }
        .slider-header {
            display: flex; justify-content: space-between; align-items: center;
            font-size: 10px; font-weight: 700; letter-spacing: 0.08em;
            text-transform: uppercase; color: #60a5fa; margin-bottom: 8px;
        }
        #opacity-value { color: #93c5fd; }
        #opacity-slider {
            -webkit-appearance: none; width: 100%; height: 3px;
            border-radius: 2px; background: rgba(59, 130, 246, 0.22); outline: none;
            cursor: pointer;
        }
        #opacity-slider::-webkit-slider-thumb {
            -webkit-appearance: none; width: 13px; height: 13px;
            border-radius: 50%; background: #3b82f6; cursor: pointer;
            box-shadow: 0 0 7px rgba(59, 130, 246, 0.7);
        }
        #opacity-slider::-moz-range-thumb {
            width: 13px; height: 13px; border-radius: 50%; background: #3b82f6;
            border: none; box-shadow: 0 0 7px rgba(59, 130, 246, 0.7);
        }

        /* ===== LEGEND (bottom-left) ===== */
        .legend {
            position: absolute; bottom: 24px; left: 16px; z-index: 1000;
            padding: 13px 16px; min-width: 220px; display: none;
        }
        .legend-title {
            font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
            text-transform: uppercase; color: #60a5fa; margin-bottom: 9px;
        }
        .legend-gradient { height: 7px; border-radius: 4px; margin-bottom: 5px; }
        .legend-labels {
            display: flex; justify-content: space-between;
            font-size: 11px; color: #64748b;
        }

        /* ===== VALUE POPUP ===== */
        .mapboxgl-popup { z-index: 1001; }
        .mapboxgl-popup-content {
            background: rgba(6, 18, 52, 0.88);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(100, 160, 255, 0.25);
            border-radius: 10px;
            box-shadow: 0 6px 24px rgba(0,0,50,0.6);
            color: #e0f0ff;
            padding: 10px 14px;
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
        }
        .mapboxgl-popup-close-button { color: #60a5fa !important; font-size: 16px; }
        .popup-layer-name {
            font-size: 9px; font-weight: 700; letter-spacing: 0.12em;
            text-transform: uppercase; color: #60a5fa; margin-bottom: 3px;
        }
        .popup-value {
            font-size: 20px; font-weight: 700;
            background: linear-gradient(135deg, #93c5fd, #818cf8);
            -webkit-background-clip: text; -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        .popup-coords { font-size: 10px; color: #475569; margin-top: 3px; }
        .popup-unavailable { font-size: 13px; color: #64748b; font-style: italic; }

        /* ===== MAPBOX GL OVERRIDES ===== */
        .mapboxgl-ctrl-logo { display: none; }
        .mapboxgl-ctrl-bottom-right { display: none; }
    </style>
</head>
<body>
<div id="map"></div>

<!-- Title badge -->
<div id="title-badge" class="glass">
    <span class="badge-text">RTMA Live Weather</span>
</div>

<!-- Status panel -->
<div id="status" class="glass loading">
    <div class="status-header">
        <span class="status-dot"></span>
        Data Status
    </div>
    <div class="status-text" id="status-text">Fetching latest data...</div>
</div>

<!-- Controls panel -->
<div id="controls" class="glass">
    <div class="panel-title">Weather Layer</div>
    <label class="layer-option">
        <input type="radio" name="layer" value="temp" checked>
        <span class="radio-dot"></span>
        <span class="layer-label">Temperature</span>
    </label>
    <label class="layer-option">
        <input type="radio" name="layer" value="wind">
        <span class="radio-dot"></span>
        <span class="layer-label">Wind Speed</span>
    </label>
    <label class="layer-option">
        <input type="radio" name="layer" value="apparent">
        <span class="radio-dot"></span>
        <span class="layer-label">Apparent Temp</span>
    </label>
    <label class="layer-option">
        <input type="radio" name="layer" value="vis">
        <span class="radio-dot"></span>
        <span class="layer-label">Visibility</span>
    </label>
    <label class="layer-option">
        <input type="radio" name="layer" value="cloud">
        <span class="radio-dot"></span>
        <span class="layer-label">Cloud Cover</span>
    </label>
    <label class="layer-option">
        <input type="radio" name="layer" value="rh">
        <span class="radio-dot"></span>
        <span class="layer-label">Rel. Humidity</span>
    </label>
    <label class="layer-option">
        <input type="radio" name="layer" value="none">
        <span class="radio-dot"></span>
        <span class="layer-label">None</span>
    </label>

    <div class="slider-section">
        <div class="slider-header">
            <span>Opacity</span>
            <span id="opacity-value">65%</span>
        </div>
        <input type="range" id="opacity-slider" min="10" max="100" value="65" step="5">
    </div>
</div>

<!-- Legend -->
<div class="legend glass" id="legend">
    <div class="legend-title" id="legend-title">Temperature (°F)</div>
    <div class="legend-gradient" id="legend-gradient"></div>
    <div class="legend-labels">
        <span id="min-label">-20</span>
        <span id="max-label">110</span>
    </div>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script>
    mapboxgl.accessToken = 'pk.eyJ1IjoiZ3RnMDExNiIsImEiOiJjbWxsODV6NXAwNThmM2ZwdWlkYm0xNjFlIn0.vI186twXYzY45nnuV5FucQ';

    var currentOpacity = 0.65;

    // Bounds stored as [minLat, minLon, maxLat, maxLon] internally.
    // Mapbox GL image sources require 4-corner coords: [NW, NE, SE, SW] as [lng, lat].
    var boundsArr = [24.0, -126.0, 50.0, -66.0]; // [minLat, minLon, maxLat, maxLon]

    // Convert boundsArr → Mapbox GL 4-corner format [NW, NE, SE, SW]
    function toMapboxCoords(b) {
        var minLat = b[0], minLon = b[1], maxLat = b[2], maxLon = b[3];
        return [
            [minLon, maxLat], // NW  top-left
            [maxLon, maxLat], // NE  top-right
            [maxLon, minLat], // SE  bottom-right
            [minLon, minLat]  // SW  bottom-left
        ];
    }

    var statusDiv  = document.getElementById('status');
    var statusText = document.getElementById('status-text');
    var legendDiv  = document.getElementById('legend');

    var legendConfigs = {
        temp:     { title: 'Temperature (°F)',          min: -20, max: 110,  gradient: 'linear-gradient(to right,#30123b,#3c59ff,#00ffff,#7cff00,#ffff00,#ff7f00,#ff0000)', unit: '°F' },
        wind:     { title: 'Wind Speed (mph)',           min: 0,   max: 60,   gradient: 'linear-gradient(to right,#440154,#3b528b,#21908c,#5dc863,#fde725)',                  unit: ' mph' },
        apparent: { title: 'Apparent Temperature (°F)', min: -40, max: 140,  gradient: 'linear-gradient(to right,#30123b,#3c59ff,#00ffff,#7cff00,#ffff00,#ff7f00,#ff0000)', unit: '°F' },
        vis:      { title: 'Visibility (miles)',         min: 0,   max: 10,   gradient: 'linear-gradient(to right,#0d0221,#3e0072,#9b00c4,#e8007a,#ff6b00,#fffb00)',           unit: ' mi' },
        cloud:    { title: 'Cloud Cover (%)',            min: 0,   max: 100,  gradient: 'linear-gradient(to right,#f7fbff,#c6dbef,#6baed6,#2171b5,#084594)',                  unit: '%' },
        rh:       { title: 'Relative Humidity (%)',     min: 0,   max: 100,  gradient: 'linear-gradient(to right,#ffffd9,#c7e9b4,#41b6c4,#225ea8,#081d58)',                  unit: '%' }
    };

    var ALL_LAYERS = ['temp', 'wind', 'apparent', 'vis', 'cloud', 'rh'];

    // ── Map init ──────────────────────────────────────────────────────────────
    var map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/dark-v11',
        center: [-98.5795, 39.8283],
        zoom: 4
    });

    // Once the Mapbox style is fully loaded, add RTMA image sources + layers.
    // Each layer is inserted BEFORE 'settlement-label' so Mapbox renders town
    // names and admin borders on top of the weather data automatically.
    map.on('load', function () {
        var coords = toMapboxCoords(boundsArr);

        ALL_LAYERS.forEach(function (name) {
            map.addSource(name + '-src', {
                type: 'image',
                url: './data/' + name + '.png',
                coordinates: coords
            });

            map.addLayer({
                id: name + '-layer',
                type: 'raster',
                source: name + '-src',
                paint: { 'raster-opacity': currentOpacity },
                layout: { visibility: name === 'temp' ? 'visible' : 'none' }
            }, 'settlement-label'); // INSERT BEFORE labels → labels render on top
        });

        // If metadata already arrived before the style loaded, apply it now
        if (pendingBounds) {
            applyBounds(pendingBounds);
            pendingBounds = null;
        }
        if (pendingLayer) {
            showLayer(pendingLayer);
            pendingLayer = null;
        }
    });

    // ── Legend ────────────────────────────────────────────────────────────────
    function updateLegend(name) {
        if (name === 'none' || !legendConfigs[name]) { legendDiv.style.display = 'none'; return; }
        var cfg = legendConfigs[name];
        document.getElementById('legend-title').textContent = cfg.title;
        document.getElementById('min-label').textContent    = cfg.min;
        document.getElementById('max-label').textContent    = cfg.max;
        document.getElementById('legend-gradient').style.background = cfg.gradient;
        legendDiv.style.display = 'block';
    }

    function getSelectedLayer() {
        var el = document.querySelector('input[name="layer"]:checked');
        return el ? el.value : 'temp';
    }

    // ── Layer switching ───────────────────────────────────────────────────────
    var pendingLayer = null; // set when map style not yet loaded

    function showLayer(val) {
        if (!map.isStyleLoaded()) { pendingLayer = val; updateLegend(val); loadLayerData(val); return; }
        ALL_LAYERS.forEach(function (name) {
            map.setLayoutProperty(name + '-layer', 'visibility', name === val ? 'visible' : 'none');
        });
        updateLegend(val);
        loadLayerData(val);
    }

    document.querySelectorAll('input[name="layer"]').forEach(function (radio) {
        radio.addEventListener('change', function () { showLayer(radio.value); });
    });

    // ── Opacity slider ────────────────────────────────────────────────────────
    var opacitySlider = document.getElementById('opacity-slider');
    var opacityLabel  = document.getElementById('opacity-value');
    opacitySlider.addEventListener('input', function () {
        currentOpacity = opacitySlider.value / 100;
        opacityLabel.textContent = opacitySlider.value + '%';
        ALL_LAYERS.forEach(function (name) {
            if (map.getLayer(name + '-layer')) {
                map.setPaintProperty(name + '-layer', 'raster-opacity', currentOpacity);
            }
        });
    });

    // ── Bounds update ─────────────────────────────────────────────────────────
    var pendingBounds = null; // set when map style not yet loaded

    function applyBounds(b) {
        boundsArr = b;
        var coords = toMapboxCoords(b);
        ALL_LAYERS.forEach(function (name) {
            if (map.getSource(name + '-src')) {
                map.getSource(name + '-src').setCoordinates(coords);
            }
        });
    }

    // ── Interactive value lookup ───────────────────────────────────────────────
    // process_rtma.py saves downsampled float32 binary files (*_data.bin).
    // Row 0 = southernmost lat (matches imshow origin='lower'), little-endian.
    var dataCache = {};
    var dataMeta  = null;
    var valuePopup = null;

    function loadLayerData(name) {
        if (name === 'none' || !dataMeta) return;
        if (dataCache[name]) return;
        fetch('./data/' + name + '_data.bin')
            .then(function (r) { if (!r.ok) throw new Error('missing'); return r.arrayBuffer(); })
            .then(function (buf) { dataCache[name] = new Float32Array(buf); })
            .catch(function () { /* layer may not exist in this GRIB file */ });
    }

    function lookupValue(name, lng, lat) {
        var arr = dataCache[name];
        if (!arr || !dataMeta) return null;
        var rows   = dataMeta.rows, cols = dataMeta.cols;
        var minLat = boundsArr[0], minLon = boundsArr[1];
        var maxLat = boundsArr[2], maxLon = boundsArr[3];
        var rowFrac = (lat - minLat) / (maxLat - minLat);
        var colFrac = (lng - minLon) / (maxLon - minLon);
        if (rowFrac < 0 || rowFrac > 1 || colFrac < 0 || colFrac > 1) return null;
        var row = Math.min(rows - 1, Math.max(0, Math.round(rowFrac * (rows - 1))));
        var col = Math.min(cols - 1, Math.max(0, Math.round(colFrac * (cols - 1))));
        var val = arr[row * cols + col];
        return (isFinite(val) && !isNaN(val)) ? val : null;
    }

    function formatValue(name, val) {
        var cfg = legendConfigs[name];
        if (!cfg) return val.toFixed(1);
        if (name === 'cloud' || name === 'rh') return Math.round(val) + cfg.unit;
        if (name === 'vis') return val.toFixed(2) + cfg.unit;
        return val.toFixed(1) + cfg.unit;
    }

    // Double-click / double-tap → show value popup.
    // Mapbox GL event provides e.lngLat (not Leaflet's e.latlng).
    map.on('dblclick', function (e) {
        var name = getSelectedLayer();
        if (name === 'none') return;

        if (valuePopup) { valuePopup.remove(); valuePopup = null; }

        var lng = e.lngLat.lng, lat = e.lngLat.lat;
        var val = lookupValue(name, lng, lat);
        var cfg = legendConfigs[name];
        var html;

        if (val !== null) {
            html = '<div class="popup-layer-name">' + cfg.title + '</div>' +
                   '<div class="popup-value">' + formatValue(name, val) + '</div>' +
                   '<div class="popup-coords">' + lat.toFixed(3) + '°, ' + lng.toFixed(3) + '°</div>';
        } else {
            html = '<div class="popup-layer-name">' + cfg.title + '</div>' +
                   '<div class="popup-unavailable">Data not available</div>' +
                   '<div class="popup-coords">' + lat.toFixed(3) + '°, ' + lng.toFixed(3) + '°</div>';
        }

        valuePopup = new mapboxgl.Popup({ closeButton: true, closeOnClick: true })
            .setLngLat([lng, lat])
            .setHTML(html)
            .addTo(map);
    });

    // Show legend for default layer right away (map layers added on 'load')
    updateLegend(getSelectedLayer());

    // ── Metadata fetch ────────────────────────────────────────────────────────
    fetch('./data/metadata.json')
        .then(function (r) { if (!r.ok) throw new Error('HTTP ' + r.status); return r.json(); })
        .then(function (meta) {
            statusDiv.classList.remove('loading');
            statusDiv.classList.add('ok');
            statusText.innerHTML = '<span style="color:#22c55e;font-weight:600">Live</span> &mdash; ' +
                new Date(meta.timestamp).toLocaleString();

            // meta.bounds = [[minLat, minLon], [maxLat, maxLon]]
            var b = meta.bounds;
            var newBounds = [b[0][0], b[0][1], b[1][0], b[1][1]];

            if (map.isStyleLoaded()) {
                applyBounds(newBounds);
            } else {
                pendingBounds = newBounds;
            }

            if (meta.data_rows && meta.data_cols) {
                dataMeta = { rows: meta.data_rows, cols: meta.data_cols };
                loadLayerData(getSelectedLayer());
            }

            if (map.isStyleLoaded()) {
                showLayer(getSelectedLayer());
            } else {
                pendingLayer = getSelectedLayer();
            }
        })
        .catch(function (err) {
            console.error(err);
            statusDiv.classList.remove('loading');
            statusDiv.classList.add('error');
            statusText.innerHTML = 'No data yet &mdash; pipeline has not run.<br>' +
                '<span style="font-size:11px;color:#64748b">Check GitHub Actions workflow.</span>';
        });
</script>
</body>
</html>
